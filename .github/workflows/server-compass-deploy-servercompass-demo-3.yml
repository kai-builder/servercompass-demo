name: Deploy to VPS - servercompass-demo-3

on:
  push:
    branches:
      - production
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST_SERVERCOMPASS_DEMO_3 }}
          username: ${{ secrets.VPS_USER_SERVERCOMPASS_DEMO_3 }}
          key: ${{ secrets.VPS_SSH_KEY_SERVERCOMPASS_DEMO_3 }}
          port: ${{ secrets.VPS_PORT_SERVERCOMPASS_DEMO_3 }}
          script: |
            set -e
            echo "üöÄ Starting deployment for servercompass-demo-3..."

            # Navigate to app directory
            cd /root/servercompass-demo-3

            # Fetch and reset to latest
            echo "üì• Fetching latest code from production..."
            git fetch origin production
            git reset --hard origin/production

            # Show current commit
            echo "üìù Deploying commit: $(git rev-parse --short HEAD) - $(git log -1 --pretty=%B)"

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm install

            # Build application
            echo "üî® Building application..."
            npm install && npm run build

            # Reload PM2 process
            echo "‚ôªÔ∏è  Reloading PM2 process..."
            pm2 reload servercompass-demo-3 || pm2 restart servercompass-demo-3 || {
              echo "‚ö†Ô∏è  PM2 process not found, starting new process..."
              pm2 start npm --name "servercompass-demo-3" -- start
            }

            # Save PM2 configuration
            pm2 save --force

            echo "‚úÖ Deployment completed successfully at $(date)"
            echo "üìä PM2 Status:"
            pm2 info servercompass-demo-3 --no-daemon
