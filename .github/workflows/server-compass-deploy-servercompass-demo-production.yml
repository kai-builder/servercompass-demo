name: Deploy to VPS - servercompass-demo-production

on:
  push:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if the push is to the configured branch
    if: github.ref == 'refs/heads/production'

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST_SERVERCOMPASS_DEMO_PRODUCTION }}
          username: ${{ secrets.VPS_USER_SERVERCOMPASS_DEMO_PRODUCTION }}
          key: ${{ secrets.VPS_SSH_KEY_SERVERCOMPASS_DEMO_PRODUCTION }}
          port: ${{ secrets.VPS_PORT_SERVERCOMPASS_DEMO_PRODUCTION }}
          script: |
            set -e
            echo "üöÄ Starting deployment for servercompass-demo-production..."

            # Navigate to app directory
            cd /root/servercompass-demo-production

            # Fetch and reset to latest
            echo "üì• Fetching latest code from production..."
            git fetch origin production
            git reset --hard origin/production

            # Show current commit
            echo "üìù Deploying commit: $(git rev-parse --short HEAD) - $(git log -1 --pretty=%B)"

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm install

            # Build application
            echo "üî® Building application..."
            npm install && npm run build

            # Reload PM2 process
            echo "‚ôªÔ∏è  Reloading PM2 process..."
            pm2 reload servercompass-demo-production || pm2 restart servercompass-demo-production || {
              echo "‚ö†Ô∏è  PM2 process not found, starting new process..."
              pm2 start npm --name "servercompass-demo-production" -- start
            }

            # Save PM2 configuration
            pm2 save --force

            echo "‚úÖ Deployment completed successfully at $(date)"
            echo "üìä PM2 Status:"
            pm2 info servercompass-demo-production --no-daemon
